<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Map with Year Range Slider & External GeoJSON</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" />

  <style>
    #map { height: 600px; }
    #slider-container {
      width: 300px;
      margin: 20px;
      font-family: sans-serif;
    }
    #year-range {
      margin: 10px 0;
    }
    #range-label {
      margin-top: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="slider-container">
  <div id="year-range"></div>
  <div id="range-label">Loading data...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

<script>
  const map = L.map('map').setView([40, -95], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let geojsonData = null;
  let geojsonLayer = null;

  const slider = document.getElementById('year-range');
  const label = document.getElementById('range-label');

  // Fetch GeoJSON data from the URL
  fetch('https://raw.githubusercontent.com/benliebersohn/petrosylvania-collection-builder/refs/heads/main/_includes/js/AOIgeoData.geojson')
    .then(response => {
      if (!response.ok) throw new Error("Network response was not ok");
      return response.json();
    })
    .then(data => {
      geojsonData = data;

      // Extract years from features to find min and max year
      const years = geojsonData.features
        .map(f => f.properties.year)
        .filter(y => typeof y === 'number')
        .sort((a, b) => a - b);

      const minYear = years[0] || 2000;
      const maxYear = years[years.length - 1] || 2025;

      // Initialize noUiSlider with actual year range
      noUiSlider.create(slider, {
        start: [minYear, maxYear],
        connect: true,
        range: {
          'min': minYear,
          'max': maxYear
        },
        step: 1,
        tooltips: true,
        format: {
          to: value => Math.round(value),
          from: value => Number(value)
        }
      });

      slider.noUiSlider.on('update', function(values) {
        const [startYear, endYear] = values.map(Number);
        label.textContent = `Showing: ${startYear} - ${endYear}`;
        updateMap(startYear, endYear);
      });

      // Initial render
      updateMap(minYear, maxYear);
    })
    .catch(err => {
      console.error("Failed to load GeoJSON:", err);
      label.textContent = "Failed to load data";
    });

  function updateMap(startYear, endYear) {
    if (!geojsonData) return;

    if (geojsonLayer) {
      geojsonLayer.remove();
    }

    // Filter features based on year range, assuming 'year' property exists and is numeric
    const filtered = {
      type: "FeatureCollection",
      features: geojsonData.features.filter(f => {
        const y = f.properties.year;
        return typeof y === 'number' && y >= startYear && y <= endYear;
      })
    };

    geojsonLayer = L.geoJSON(filtered, {
      onEachFeature: (feature, layer) => {
        // Customize popup content here if needed
        layer.bindPopup(`Name: ${feature.properties.name || 'N/A'}<br>Year: ${feature.properties.year}`);
      }
    }).addTo(map);
  }
</script>

</body>
</html>
